<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CF AI Customer Support</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #ff6b35;
            --primary-dark: #e55a2b;
            --primary-light: #ff8c66;
            --secondary-color: #6c757d;
            --dark-color: #2d3748;
            --light-color: #f8f9fa;
            --white: #ffffff;
            --orange-light: #fff5f0;
            --orange-lighter: #fffaf5;
            --success-color: #10b981;
            --info-color: #3b82f6;
            --warning-color: #f59e0b;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--white);
            color: var(--dark-color);
            line-height: 1.6;
        }
        
        .hero-section {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 4rem 0;
            border-radius: 0 0 30px 30px;
            margin-bottom: 3rem;
        }
        
        .feature-card {
            transition: all 0.3s ease;
            border: none;
            border-radius: 15px;
            overflow: hidden;
            height: 100%;
            background: var(--white);
            border: 1px solid #e2e8f0;
            cursor: pointer;
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(255, 107, 53, 0.15);
            border-color: var(--primary-color);
        }
        
        .feature-icon {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        
        .chat-container {
            background-color: var(--white);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            margin-bottom: 2rem;
            border: 1px solid #e2e8f0;
        }
        
        .chat-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1.5rem;
            text-align: center;
        }
        
        .chat-messages {
            height: 400px;
            overflow-y: auto;
            padding: 1.5rem;
            background-color: var(--orange-light);
        }
        
        .message {
            margin-bottom: 1rem;
            padding: 0.75rem 1.25rem;
            border-radius: 18px;
            max-width: 80%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        
        .ai-message {
            background-color: var(--white);
            color: var(--dark-color);
            border-bottom-left-radius: 5px;
            border: 1px solid #e2e8f0;
        }
        
        .voice-message {
            background: linear-gradient(135deg, var(--info-color) 0%, #2563eb 100%);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
            font-style: italic;
        }
        
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 10px 15px;
            background: var(--white);
            border-radius: 18px;
            border: 1px solid #e2e8f0;
            max-width: 80px;
            margin-bottom: 1rem;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--primary-color);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        .input-group {
            border-top: 1px solid #e2e8f0;
            background: var(--white);
            padding: 1rem;
        }
        
        .btn {
            transition: all 0.3s ease;
            border: none;
            font-weight: 600;
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, #d4491f 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
        }
        
        .btn-outline-primary {
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            background: transparent;
        }
        
        .btn-outline-primary:hover {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
        }
        
        .voice-btn {
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--primary-color);
            background: var(--white);
            color: var(--primary-color);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .voice-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
        }
        
        .voice-btn.listening {
            background: var(--primary-color);
            color: white;
            animation: pulse 1.5s infinite;
        }
        
        .voice-btn.recording::before {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border: 2px solid #ef4444;
            border-radius: 50%;
            animation: recordingPulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 107, 53, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(255, 107, 53, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 107, 53, 0); }
        }
        
        @keyframes recordingPulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }
        
        .action-btn {
            flex: 1;
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
            border-radius: 8px;
            border: 1px solid var(--primary-color);
            background: transparent;
            color: var(--primary-color);
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .action-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        
        .online { background-color: var(--success-color); }
        .offline { background-color: #ef4444; }
        
        .memory-panel {
            background-color: var(--white);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid #e2e8f0;
        }
        
        .memory-item {
            padding: 0.75rem;
            border-bottom: 1px solid #e2e8f0;
            background: var(--orange-light);
            margin-bottom: 0.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .memory-item:hover {
            background: var(--orange-lighter);
            transform: translateX(5px);
        }
        
        .navbar {
            background: var(--white) !important;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .navbar-brand {
            color: var(--primary-color) !important;
            font-weight: 700;
        }
        
        .nav-link {
            color: var(--dark-color) !important;
            font-weight: 500;
            transition: all 0.3s ease;
            border-radius: 8px;
            margin: 0 0.2rem;
            padding: 0.5rem 1rem !important;
        }
        
        .nav-link:hover, .nav-link.active {
            color: var(--primary-color) !important;
            background: var(--orange-light);
        }
        
        footer {
            background-color: var(--dark-color);
            color: white;
            padding: 2rem 0;
            margin-top: 3rem;
        }
        
        .progress-bar {
            background-color: var(--primary-color);
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(255, 107, 53, 0.25);
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }

        .toast {
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            border: none;
        }

        .btn-pill {
            border-radius: 50px;
            padding-left: 1.5rem;
            padding-right: 1.5rem;
        }
        
        .btn-icon {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .gradient-text {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .ticket-card {
            border-left: 4px solid var(--primary-color);
            transition: all 0.3s ease;
        }
        
        .ticket-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .voice-level {
            display: flex;
            align-items: center;
            gap: 3px;
            margin-top: 5px;
        }

        .voice-bar {
            width: 3px;
            height: 5px;
            background: var(--primary-color);
            border-radius: 2px;
            transition: all 0.1s ease;
        }

        @media (max-width: 768px) {
            .hero-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .hero-buttons .btn {
                width: 100%;
                max-width: 300px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .message {
                max-width: 90%;
            }
        }
    </style>
</head>
<body>
    <!-- Toast Notifications -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Voice Recognition Status -->
    <div class="modal fade" id="voiceModal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <div class="voice-level mb-3" id="voiceLevel">
                        <div class="voice-bar"></div>
                        <div class="voice-bar"></div>
                        <div class="voice-bar"></div>
                        <div class="voice-bar"></div>
                        <div class="voice-bar"></div>
                        <div class="voice-bar"></div>
                        <div class="voice-bar"></div>
                    </div>
                    <h5>Listening...</h5>
                    <p class="text-muted" id="voiceStatus">Speak now</p>
                    <div id="voiceTranscript" class="mb-2 p-2 bg-light rounded"></div>
                    <button class="btn btn-danger btn-sm" id="stopVoice">Stop</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light sticky-top">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-cloud-fill me-2"></i>
                CF AI Customer Support
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#support">Support Chat</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#tickets">My Tickets</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#status">System Status</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-section">
        <div class="container text-center">
            <h1 class="display-4 fw-bold mb-3">CF AI Customer Support</h1>
            <p class="lead mb-4">24/7 AI-powered customer support powered by Cloudflare Workers AI</p>
            <div class="hero-buttons">
                <button class="btn btn-light btn-lg px-4 btn-pill btn-icon" id="startChat">
                    <i class="bi bi-chat-dots"></i> Start Chat
                </button>
                <button class="btn btn-outline-light btn-lg px-4 btn-pill btn-icon" id="createTicket">
                    <i class="bi bi-ticket"></i> Create Ticket
                </button>
            </div>
        </div>
    </section>

    <!-- Support Chat Section -->
    <section id="support" class="container mb-5">
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="chat-container">
                    <div class="chat-header">
                        <h4 class="mb-0">AI Support Assistant</h4>
                        <small>Powered by Cloudflare Workers AI & Llama 3.3</small>
                    </div>
                    <div class="chat-messages" id="chatMessages">
                        <div class="message ai-message">
                            <strong>Support AI:</strong> Hello! I'm your Cloudflare AI Support Assistant. How can I help you with Cloudflare services today?
                        </div>
                    </div>
                    <div class="input-group">
                        <input type="text" class="form-control" id="userInput" placeholder="Describe your issue or click the microphone to speak...">
                        <button class="btn voice-btn me-2" id="voiceBtn" title="Voice Input">
                            <i class="bi bi-mic"></i>
                        </button>
                        <button class="btn btn-primary me-2 btn-pill" id="sendBtn">
                            <i class="bi bi-send"></i> Send
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Quick Actions Section -->
    <section class="container mb-5">
        <div class="row text-center mb-4">
            <div class="col">
                <h3 class="fw-bold gradient-text">Quick Solutions</h3>
                <p class="text-muted">Common Cloudflare issues and solutions</p>
            </div>
        </div>
        <div class="row g-4">
            <div class="col-md-6 col-lg-3">
                <div class="card feature-card">
                    <div class="card-body text-center p-4">
                        <div class="feature-icon">
                            <i class="bi bi-shield-check"></i>
                        </div>
                        <h5 class="card-title">SSL/TLS Issues</h5>
                        <p class="card-text">Troubleshoot SSL certificate problems and HTTPS configuration.</p>
                        <button class="btn action-btn" data-issue="ssl">
                            Get Help
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="card feature-card">
                    <div class="card-body text-center p-4">
                        <div class="feature-icon">
                            <i class="bi bi-speedometer2"></i>
                        </div>
                        <h5 class="card-title">Performance</h5>
                        <p class="card-text">Optimize cache settings and improve loading times.</p>
                        <button class="btn action-btn" data-issue="performance">
                            Optimize
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="card feature-card">
                    <div class="card-body text-center p-4">
                        <div class="feature-icon">
                            <i class="bi bi-robot"></i>
                        </div>
                        <h5 class="card-title">Workers AI</h5>
                        <p class="card-text">Help with AI model integration and inference issues.</p>
                        <button class="btn action-btn" data-issue="workers-ai">
                            Configure
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="card feature-card">
                    <div class="card-body text-center p-4">
                        <div class="feature-icon">
                            <i class="bi bi-cash-coin"></i>
                        </div>
                        <h5 class="card-title">Billing</h5>
                        <p class="card-text">Questions about pricing, invoices, and account management.</p>
                        <button class="btn action-btn" data-issue="billing">
                            Resolve
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Tickets Section -->
    <section id="tickets" class="container mb-5">
        <div class="row">
            <div class="col-12">
                <div class="memory-panel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="mb-0 gradient-text">Support Tickets</h4>
                        <button class="btn btn-primary btn-pill btn-icon" id="newTicketBtn">
                            <i class="bi bi-plus-circle"></i> New Ticket
                        </button>
                    </div>
                    <div id="ticketsList">
                        <div class="card ticket-card mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h5 class="card-title">SSL Certificate Error</h5>
                                        <p class="card-text text-muted">Getting "SSL Handshake Failed" on my domain</p>
                                        <span class="badge bg-warning">In Progress</span>
                                        <small class="text-muted">Created: 2025-01-15</small>
                                    </div>
                                    <button class="btn btn-outline-primary btn-sm">View</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- System Status Section -->
    <section id="status" class="container mb-5">
        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="memory-panel">
                    <h4 class="mb-3 gradient-text">Conversation History</h4>
                    <div id="memoryItems">
                        <div class="memory-item">
                            <strong>Session Started:</strong> User initiated support chat
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="memory-panel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="mb-0 gradient-text">System Status</h4>
                        <button class="btn btn-sm btn-outline-primary" id="refreshStatus">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Workers AI (Llama 3.3)</span>
                            <span class="badge bg-success">Online</span>
                        </div>
                        <div class="progress mt-1" style="height: 8px; border-radius: 4px;">
                            <div class="progress-bar" role="progressbar" style="width: 95%"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>KV Storage</span>
                            <span class="badge bg-success">Online</span>
                        </div>
                        <div class="progress mt-1" style="height: 8px; border-radius: 4px;">
                            <div class="progress-bar" role="progressbar" style="width: 65%"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Durable Objects</span>
                            <span class="badge bg-success">Online</span>
                        </div>
                        <div class="progress mt-1" style="height: 8px; border-radius: 4px;">
                            <div class="progress-bar" role="progressbar" style="width: 42%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="d-flex justify-content-between">
                            <span>Response Time</span>
                            <span class="badge bg-success">128ms</span>
                        </div>
                        <div class="progress mt-1" style="height: 8px; border-radius: 4px;">
                            <div class="progress-bar" role="progressbar" style="width: 88%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="container text-center">
            <p class="mb-2">CF AI Customer Support</p>
            <p class="mb-0">Powered by Cloudflare Workers AI, Pages, and Durable Objects</p>
            <p>Repository: cf_ai_customer_support</p>
        </div>
    </footer>

    <!-- Bootstrap JS with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const chatMessages = document.getElementById('chatMessages');
            const userInput = document.getElementById('userInput');
            const sendBtn = document.getElementById('sendBtn');
            const voiceBtn = document.getElementById('voiceBtn');
            const memoryItems = document.getElementById('memoryItems');
            const toastContainer = document.getElementById('toastContainer');
            const voiceModal = new bootstrap.Modal(document.getElementById('voiceModal'));
            const voiceTranscript = document.getElementById('voiceTranscript');
            const voiceStatus = document.getElementById('voiceStatus');
            const voiceLevel = document.getElementById('voiceLevel');
            const stopVoiceBtn = document.getElementById('stopVoice');
            
            // Voice Recognition Variables
            let recognition = null;
            let isListening = false;
            let finalTranscript = '';
            let sessionId = 'session_' + Date.now();
            let conversationHistory = [];
            let isWaitingForResponse = false;
            
            // Initialize Speech Recognition
            function initializeSpeechRecognition() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                
                if (!SpeechRecognition) {
                    showToast('Speech recognition is not supported in this browser. Please use Chrome or Edge.', 'warning');
                    voiceBtn.disabled = true;
                    voiceBtn.title = 'Speech recognition not supported';
                    return false;
                }
                
                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'en-US';
                
                recognition.onstart = function() {
                    isListening = true;
                    voiceBtn.classList.add('listening', 'recording');
                    voiceBtn.innerHTML = '<i class="bi bi-mic-fill"></i>';
                    voiceModal.show();
                    showToast('Voice recognition started. Speak now!', 'info');
                };
                
                recognition.onresult = function(event) {
                    let interimTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    // Update the transcript display
                    voiceTranscript.innerHTML = finalTranscript + '<em style="color: #666;">' + interimTranscript + '</em>';
                    
                    // Simulate voice level visualization
                    updateVoiceLevel();
                };
                
                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    stopVoiceRecognition();
                    
                    let errorMessage = 'Voice recognition error: ';
                    switch(event.error) {
                        case 'no-speech':
                            errorMessage = 'No speech detected. Please try again.';
                            break;
                        case 'audio-capture':
                            errorMessage = 'No microphone found. Please check your microphone.';
                            break;
                        case 'not-allowed':
                            errorMessage = 'Microphone access denied. Please allow microphone access.';
                            break;
                        default:
                            errorMessage = 'Error with voice recognition: ' + event.error;
                    }
                    
                    showToast(errorMessage, 'warning');
                };
                
                recognition.onend = function() {
                    if (isListening) {
                        // If still listening, restart recognition (for continuous listening)
                        recognition.start();
                    }
                };
                
                return true;
            }
            
            // Start voice recognition
            function startVoiceRecognition() {
                if (!recognition && !initializeSpeechRecognition()) {
                    return;
                }
                
                try {
                    finalTranscript = '';
                    voiceTranscript.innerHTML = '';
                    voiceStatus.textContent = 'Speak now...';
                    recognition.start();
                } catch (error) {
                    console.error('Error starting voice recognition:', error);
                    showToast('Error starting voice recognition', 'error');
                }
            }
            
            // Stop voice recognition
            function stopVoiceRecognition() {
                isListening = false;
                if (recognition) {
                    recognition.stop();
                }
                
                voiceBtn.classList.remove('listening', 'recording');
                voiceBtn.innerHTML = '<i class="bi bi-mic"></i>';
                voiceModal.hide();
                
                // If we have a final transcript, use it
                if (finalTranscript.trim()) {
                    userInput.value = finalTranscript;
                    showToast('Voice input captured!', 'success');
                    
                    // Add voice message to chat
                    addVoiceMessage(finalTranscript);
                    
                    // Auto-send after voice input
                    setTimeout(() => {
                        sendMessage();
                    }, 500);
                }
            }
            
            // Add voice message to chat
            function addVoiceMessage(message) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message voice-message';
                messageDiv.innerHTML = `
                    <strong>You (Voice):</strong> ${message}
                    <div><small><i class="bi bi-mic-fill"></i> Voice input</small></div>
                `;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                addMemoryItem(`Voice input: ${message}`);
                conversationHistory.push({ type: 'user', content: message, timestamp: new Date(), input: 'voice' });
            }
            
            // Simulate voice level visualization
            function updateVoiceLevel() {
                const bars = voiceLevel.querySelectorAll('.voice-bar');
                bars.forEach((bar, index) => {
                    const randomHeight = 5 + Math.random() * 15;
                    bar.style.height = `${randomHeight}px`;
                    bar.style.background = `hsl(${210 + index * 10}, 70%, 50%)`;
                });
            }
            
            // Utility Functions
            function showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast align-items-center text-bg-${type} border-0`;
                toast.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                `;
                toastContainer.appendChild(toast);
                
                const bsToast = new bootstrap.Toast(toast);
                bsToast.show();
                
                toast.addEventListener('hidden.bs.toast', () => {
                    toast.remove();
                });
            }
            
            function addMessage(message, isUser = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
                
                if (isUser) {
                    messageDiv.innerHTML = `<strong>You:</strong> ${message}`;
                    addMemoryItem(`User: ${message}`);
                    conversationHistory.push({ type: 'user', content: message, timestamp: new Date() });
                } else {
                    messageDiv.innerHTML = `<strong>Support AI:</strong> ${message}`;
                    conversationHistory.push({ type: 'assistant', content: message, timestamp: new Date() });
                }
                
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            function showTypingIndicator() {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'typing-indicator';
                typingDiv.innerHTML = `
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                `;
                chatMessages.appendChild(typingDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                return typingDiv;
            }
            
            function addMemoryItem(text) {
                const memoryItem = document.createElement('div');
                memoryItem.className = 'memory-item';
                memoryItem.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${text}`;
                memoryItems.appendChild(memoryItem);
                memoryItems.scrollTop = memoryItems.scrollHeight;
            }
            
            // Chat Functionality
            async function sendMessage() {
                const message = userInput.value.trim();
                if (message && !isWaitingForResponse) {
                    if (!message.startsWith('I need help with my')) { // Don't add duplicate voice messages
                        addMessage(message, true);
                    }
                    userInput.value = '';
                    isWaitingForResponse = true;
                    
                    const typingIndicator = showTypingIndicator();
                    
                    try {
                        const response = await fetch('/api/chat', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ 
                                message: message,
                                sessionId: sessionId,
                                history: conversationHistory.slice(-6)
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        typingIndicator.remove();
                        
                        if (data.response) {
                            addMessage(data.response, false);
                        } else {
                            addMessage("I understand your question. Let me help you with that. Could you provide more details about your specific issue with Cloudflare services?", false);
                        }
                    } catch (error) {
                        console.error('Error calling worker:', error);
                        typingIndicator.remove();
                        const fallbackResponses = [
                            "I can help you with Cloudflare services. For SSL issues, check your certificate configuration in the Cloudflare dashboard.",
                            "For performance optimization, try enabling Auto Minify and Brotli compression in the Speed optimization settings.",
                            "With Workers AI, you can run machine learning models directly on Cloudflare's edge network. What specific issue are you facing?",
                            "For billing questions, you can view your current usage and invoices in the Billing section of your account."
                        ];
                        const randomResponse = fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)];
                        addMessage(randomResponse, false);
                        showToast('Using fallback mode - worker may be offline', 'warning');
                    } finally {
                        isWaitingForResponse = false;
                    }
                }
            }
            
            // Event Listeners
            voiceBtn.addEventListener('click', function() {
                if (!isListening) {
                    startVoiceRecognition();
                } else {
                    stopVoiceRecognition();
                }
            });
            
            stopVoiceBtn.addEventListener('click', stopVoiceRecognition);
            
            sendBtn.addEventListener('click', sendMessage);
            
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !isWaitingForResponse) {
                    sendMessage();
                }
            });
            
            // Quick action buttons
            document.querySelectorAll('.action-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const issue = this.dataset.issue;
                    const questions = {
                        'ssl': "I'm having SSL certificate issues with my domain. Can you help me troubleshoot?",
                        'performance': "My website performance seems slow with Cloudflare. How can I optimize it?",
                        'workers-ai': "I need help integrating Workers AI with my existing Cloudflare Worker.",
                        'billing': "I have questions about my Cloudflare billing and subscription."
                    };
                    
                    if (questions[issue]) {
                        userInput.value = questions[issue];
                        sendMessage();
                    }
                });
            });
            
            // Other button event listeners (same as before)
            document.getElementById('startChat').addEventListener('click', function() {
                document.getElementById('support').scrollIntoView({ behavior: 'smooth' });
                userInput.focus();
                showToast('Ready to help! What can I assist you with?', 'info');
            });
            
            document.getElementById('createTicket').addEventListener('click', function() {
                const ticketSubject = prompt("Please enter a subject for your support ticket:");
                if (ticketSubject) {
                    const ticketDescription = prompt("Please describe your issue in detail:");
                    if (ticketDescription) {
                        fetch('/api/tickets', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                subject: ticketSubject,
                                description: ticketDescription,
                                sessionId: sessionId
                            })
                        }).catch(error => {
                            console.log('Ticket API not available, using local storage');
                        });
                        
                        showToast('Support ticket created successfully!', 'success');
                        addMemoryItem(`New ticket created: ${ticketSubject}`);
                        
                        const ticketsList = document.getElementById('ticketsList');
                        const newTicket = document.createElement('div');
                        newTicket.className = 'card ticket-card mb-3';
                        newTicket.innerHTML = `
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h5 class="card-title">${ticketSubject}</h5>
                                        <p class="card-text text-muted">${ticketDescription}</p>
                                        <span class="badge bg-primary">New</span>
                                        <small class="text-muted">Created: ${new Date().toLocaleDateString()}</small>
                                    </div>
                                    <button class="btn btn-outline-primary btn-sm">View</button>
                                </div>
                            </div>
                        `;
                        ticketsList.prepend(newTicket);
                    }
                }
            });
            
            document.getElementById('newTicketBtn').addEventListener('click', function() {
                document.getElementById('createTicket').click();
            });
            
            document.getElementById('refreshStatus').addEventListener('click', function() {
                showToast('System status updated', 'success');
                document.querySelectorAll('.progress-bar').forEach(bar => {
                    const newWidth = Math.min(100, Math.max(10, parseInt(bar.style.width) + Math.random() * 20 - 10));
                    bar.style.width = `${newWidth}%`;
                });
            });
            
            // Navigation smooth scroll
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                });
            });
            
            // Auto-focus on input when page loads
            userInput.focus();
            
            // Initialize session
            addMemoryItem(`Session started: ${sessionId}`);
            
            // Check for microphone permission
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(function(stream) {
                        console.log('Microphone access granted');
                        // Stop all tracks to release microphone
                        stream.getTracks().forEach(track => track.stop());
                    })
                    .catch(function(err) {
                        console.log('Microphone access denied:', err);
                        showToast('Microphone access is required for voice input. Please allow microphone access in your browser settings.', 'warning');
                    });
            }
        });
    </script>
</body>
</html>
